<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { 
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { 
  getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc 
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY_ANDA",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ELEMENT
const loginBox = document.getElementById("login");
const adminBox = document.getElementById("admin");
const tabel = document.getElementById("tabel");
const email = document.getElementById("email");
const password = document.getElementById("password");
const pesan = document.getElementById("pesan");

let unsub = null;

// STATUS LOGIN
onAuthStateChanged(auth, user => {
  if (user) {
    loginBox.style.display = "none";
    adminBox.classList.remove("hidden");
    loadData();
  } else {
    loginBox.style.display = "block";
    adminBox.classList.add("hidden");
    tabel.innerHTML = "";
    if (unsub) unsub();
  }
});

// LOGIN
window.login = async function () {
  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
    pesan.innerText = "";
  } catch (e) {
    pesan.innerText = "âŒ Email atau password salah";
  }
};

// LOGOUT
window.logout = function () {
  signOut(auth);
};

// LOAD DATA
function loadData() {
  let no = 1;
  unsub = onSnapshot(collection(db, "ppdb"), snap => {
    tabel.innerHTML = "";
    no = 1;
    snap.forEach(d => {
      const x = d.data();
      tabel.innerHTML += `
        <tr>
          <td>${no++}</td>
          <td>${x.nama || "-"}</td>
          <td>${x.nisn || "-"}</td>
          <td>${x.asal || "-"}</td>
          <td>${x.jurusan || "-"}</td>
          <td>
            <button class="edit" onclick="editData('${d.id}','${x.nama || ""}')">Edit</button>
            <button class="hapus" onclick="hapusData('${d.id}')">Hapus</button>
          </td>
        </tr>`;
    });
  });
}

// EDIT
window.editData = async function (id, nama) {
  const baru = prompt("Nama baru:", nama);
  if (baru) {
    await updateDoc(doc(db, "ppdb", id), { nama: baru });
  }
};

// HAPUS
window.hapusData = async function (id) {
  if (confirm("Hapus data ini?")) {
    await deleteDoc(doc(db, "ppdb", id));
  }
};
</script>


